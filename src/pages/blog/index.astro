---
import { getCollection } from 'astro:content'
import Layout from '../../layouts/Layout.astro'
import { BlogCard } from '../../components/BlogCard'
import { Temporal } from '@js-temporal/polyfill'

const isProd = import.meta.env.PROD

const allPosts = await getCollection('blog')
console.log('DEBUG: allPosts count', allPosts.length)

function toTemporal(date: Date) {
  return Temporal.PlainDate.from(date.toISOString().split('T')[0])
}

const posts = allPosts
  .filter((post) => {
    const status = post.data.status
    console.log(`DEBUG: post ${post.id} status: ${status}`)
    if (isProd) {
      return status === 'published' || status === 'locked'
    }
    return true
  })
  .sort((a, b) => {
    const dateA = toTemporal(a.data.pubDate)
    const dateB = toTemporal(b.data.pubDate)
    return Temporal.PlainDate.compare(dateB, dateA)
  })

function getSlug(id: string) {
  return id
    .replace(/^src\/content\/blog\//, '')
    .replace(/\/index\.mdx$/, '')
    .replace(/\.mdx?$/, '')
}
---

<Layout title="All posts">
  <h1 class="text-3xl font-bold mb-8">All posts</h1>
  <div class="space-y-8">
    {
      posts.map(post => (
        <BlogCard
          title={post.data.title}
          description={post.data.description}
          pubDate={toTemporal(post.data.pubDate)}
          href={`/blog/${getSlug(post.id)}/`}
          labels={post.data.labels}
          client:visible
        />
      ))
    }
  </div>
</Layout>
